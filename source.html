<!--
    This is a demo of SharpTools Custom Tile feature that can be used to integrate with 
    Spotify via the Spotify Developer App created by individual user. Please note that
    this is NOT an official integration between SharpTools and Spotify. :-)
-->

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
<!--
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css">
-->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.sharptools.io/js/custom-tiles.js"></script>
<style>
html{background-color:#212529;}
#playback #temp-album-art {width:100%; height: 100%; padding:1rem;}
#playback #album-art {width:100%; height:100%;}
#player {width:100%;}
#player .controls {cursor:pointer;}
#player .controls svg {width:100%; height: 100%;}
#playback-info {position:relative;}
#playback-info #title, #playback-info #artist {font-size:1.2rem;}
#player {position:absolute; bottom:5px; left:0px; margin-left:auto; margin-right:auto;}
#lists .list-group-item {cursor: pointer;}
#lists .active {background-color:#f8f9fa!important; color:#212529!important; border:unset;}
#player .controls.active {color: #1dd05d;}

/*content(list) Scroll bar style*/
#content{
    scrollbar-shadow-color: #141414;
    scrollbar-highlight-color: #141414;
    scrollbar-3dlight-color: #141414;
    scrollbar-darkshadow-color: #141414;
    scrollbar-track-color: #141414;
    scrollbar-arrow-color: #141414;
}
#content::-webkit-scrollbar {width: 12px;} 
#content::-webkit-scrollbar-track {
    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3); 
    -webkit-border-radius: 10px;
    border-radius: 10px;
}
#content::-webkit-scrollbar-thumb {
    -webkit-border-radius: 10px;
    border-radius: 10px;
    background: rgba(20,20,20,0.8); 
    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.5); 
}
</style>
<div id="spotify-main" class="text-light bg-dark">  
  <div id="playback" class="row g-0">
    <div class="col-4 g-0">
      <svg id="temp-album-art" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-music-note-beamed" viewBox="0 0 16 16">
        <path d="M6 13c0 1.105-1.12 2-2.5 2S1 14.105 1 13c0-1.104 1.12-2 2.5-2s2.5.896 2.5 2zm9-2c0 1.105-1.12 2-2.5 2s-2.5-.895-2.5-2 1.12-2 2.5-2 2.5.895 2.5 2z"/>
        <path fill-rule="evenodd" d="M14 11V2h1v9h-1zM6 3v10H5V3h1z"/>
        <path d="M5 2.905a1 1 0 0 1 .9-.995l8-.8a1 1 0 0 1 1.1.995V3L5 4V2.905z"/>
      </svg>      
      <img class="img-responsive" id="album-art" style="display:none;"/>
    </div>
    <div id="playback-info" class="col-8 gx-2">
      <div id="title"></div>
      <div id="artist"></div>
      <div id="player" class="container">
        <div class="row row row-cols-6">
          <span class="controls col text-center" onclick="controlPlayer('previous')">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-skip-backward-fill" viewBox="0 0 16 16">
  <path d="M.5 3.5A.5.5 0 0 0 0 4v8a.5.5 0 0 0 1 0V8.753l6.267 3.636c.54.313 1.233-.066 1.233-.697v-2.94l6.267 3.636c.54.314 1.233-.065 1.233-.696V4.308c0-.63-.693-1.01-1.233-.696L8.5 7.248v-2.94c0-.63-.692-1.01-1.233-.696L1 7.248V4a.5.5 0 0 0-.5-.5z"/>
</svg>
          </span>
          <span id="ctrl-pause" class="controls col text-center" style="display:none;" onclick="controlPlayer('pause')">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pause-circle-fill" viewBox="0 0 16 16">
  <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.25 5C5.56 5 5 5.56 5 6.25v3.5a1.25 1.25 0 1 0 2.5 0v-3.5C7.5 5.56 6.94 5 6.25 5zm3.5 0c-.69 0-1.25.56-1.25 1.25v3.5a1.25 1.25 0 1 0 2.5 0v-3.5C11 5.56 10.44 5 9.75 5z"/>
</svg>
          </span>
          <span id="ctrl-play" class="controls col text-center" onclick="controlPlayer('play')">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-circle-fill" viewBox="0 0 16 16">
  <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z"/>
</svg>
          </span>
          <span class="controls col text-center" onclick="controlPlayer('next')">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-skip-forward-fill" viewBox="0 0 16 16">
  <path d="M15.5 3.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V8.753l-6.267 3.636c-.54.313-1.233-.066-1.233-.697v-2.94l-6.267 3.636C.693 12.703 0 12.324 0 11.693V4.308c0-.63.693-1.01 1.233-.696L7.5 7.248v-2.94c0-.63.693-1.01 1.233-.696L15 7.248V4a.5.5 0 0 1 .5-.5z"/>
</svg>
          </span>
          <span class="controls col text-center" onclick="getDevices(true)">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-speaker-fill" viewBox="0 0 16 16">
  <path d="M9 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-2.5 6.5a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0z"/>
  <path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4zm6 4a2 2 0 1 1-4 0 2 2 0 0 1 4 0zM8 7a3.5 3.5 0 1 1 0 7 3.5 3.5 0 0 1 0-7z"/>
</svg>
          </span>        
          <span class="controls col text-center" onclick="getPlaylists()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-music-note-list" viewBox="0 0 16 16">
  <path d="M12 13c0 1.105-1.12 2-2.5 2S7 14.105 7 13s1.12-2 2.5-2 2.5.895 2.5 2z"/>
  <path fill-rule="evenodd" d="M12 3v10h-1V3h1z"/>
  <path d="M11 2.82a1 1 0 0 1 .804-.98l3-.6A1 1 0 0 1 16 2.22V4l-5 1V2.82z"/>
  <path fill-rule="evenodd" d="M0 11.5a.5.5 0 0 1 .5-.5H4a.5.5 0 0 1 0 1H.5a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 .5 7H8a.5.5 0 0 1 0 1H.5a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 .5 3H8a.5.5 0 0 1 0 1H.5a.5.5 0 0 1-.5-.5z"/>
</svg>
          </span>
          <span id="ctrl-shuffle" class="controls col text-center" onclick="shuffle()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shuffle" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M0 3.5A.5.5 0 0 1 .5 3H1c2.202 0 3.827 1.24 4.874 2.418.49.552.865 1.102 1.126 1.532.26-.43.636-.98 1.126-1.532C9.173 4.24 10.798 3 13 3v1c-1.798 0-3.173 1.01-4.126 2.082A9.624 9.624 0 0 0 7.556 8a9.624 9.624 0 0 0 1.317 1.918C9.828 10.99 11.204 12 13 12v1c-2.202 0-3.827-1.24-4.874-2.418A10.595 10.595 0 0 1 7 9.05c-.26.43-.636.98-1.126 1.532C4.827 11.76 3.202 13 1 13H.5a.5.5 0 0 1 0-1H1c1.798 0 3.173-1.01 4.126-2.082A9.624 9.624 0 0 0 6.444 8a9.624 9.624 0 0 0-1.317-1.918C4.172 5.01 2.796 4 1 4H.5a.5.5 0 0 1-.5-.5z"/>
  <path d="M13 5.466V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192zm0 9v-3.932a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192z"/>
</svg>
          </span>
        </div>      
      </div>
    </div>  
  </div>
  <div id="content" class="overflow-auto">
    <ul id="lists" class="list-group">
    </ul>    
  </div>  
</div>
<script>
let apiUrl = "https://api.spotify.com/v1";
let authUrl = "https://accounts.spotify.com/authorize";
let token;
let refreshToken
let btnSignin = document.getElementById("btn-signin");
let divPlaybackInfo = document.getElementById("playback-info");
let ulLists = document.getElementById("lists");
let divTitle = document.getElementById("title");
let divArtist = document.getElementById("artist");
let divContent = document.getElementById("content");
let tempAlbumArt = document.getElementById("temp-album-art"); 
let imgAlbumArt = document.getElementById("album-art");
let ctrlPlay = document.getElementById("ctrl-play");
let ctrlPause = document.getElementById("ctrl-pause");
let ctrlShuffle = document.getElementById("ctrl-shuffle");

let spotifyRefreshTimer;
let spotifyData = {};
let userSettings;
let activeDeviceId;
let tileSize = {
  height: window.innerHeight,
  width: window.innerWidth
};
let contentHeight = tileSize.height - divPlaybackInfo.clientHeight;
divContent.style.height = `${contentHeight}px`;

stio.ready(async (data)=>{
  console.log("stio is ready");
  userSettings= data && data.settings;
  //Token expires every hour so it's likely is is expired when loaded.
  await getNewToken();
  await getPlaylists();
  getCurrPlayback();
  getDevices();  
});

async function getNewToken(){
  console.log("Refreshing token");
  try{
    let res = await axios.post(`https://accounts.spotify.com/api/token`,  
      `grant_type=refresh_token&refresh_token=${userSettings.refreshToken}`,
      {
        headers: {
          "Authorization": "Basic " + btoa(userSettings.clientId + ":" + userSettings.clientSecret),
          "content-Type": "application/x-www-form-urlencoded"
        }
      });
    //Store the received new token  
    if(res && res.data && res.data.access_token){
      console.log("Received new token");
      userSettings.token = res.data.access_token;
    }
  }
  catch(err){
    console.error(err);
    //console.log(JSON.stringify(err.response));
  }
}

function removeAllChildNodes(parent) {
  //To remove the list items and their listeners
  while (parent.firstChild) {
      parent.removeChild(parent.firstChild);
  }
}

async function getPlaylists(){
  try{
    let res = await axios.get(`${apiUrl}/me/playlists`, {
      headers: {"Authorization": "Bearer " + userSettings.token}});
    if(res.data && res.data.items){
      spotifyData.playlists = res.data.items;      
      removeAllChildNodes(ulLists);
      for(let playlist of res.data.items){
        let item = document.createElement("li");
        item.classList.add('list-group-item');
        item.classList.add('bg-dark');
        item.setAttribute("id", playlist.uri);
        item.onclick = function(){controlPlayer("play",{contextUri: playlist.uri})};
        item.appendChild(document.createTextNode(playlist.name));
        ulLists.appendChild(item);
      }
    }     
  }
  catch(err){
    console.error(err);
    if(err.response && isTokenExpiredError(err.response)){
      await getNewToken(); 
      await getPlaylists();
    }
  }   
}

function setActiveDevice(deviceId, play=false, listToShow=null){
  console.log(`Active Device: ${deviceId}`);
  activeDeviceId = deviceId;
  //Update the list content if specified
  if(listToShow === "playlists"){
    getPlaylists();
  }
}

async function getDevices(showDeviceList=false){
  try{
    let res = await axios.get(`${apiUrl}/me/player/devices`, {
      headers: {"Authorization": "Bearer " + userSettings.token}});
    if(res.data && res.data.devices){
      spotifyData.devices = res.data.devices;
      if(showDeviceList){
        removeAllChildNodes(ulLists);
        for (let device of spotifyData.devices){
          let item = document.createElement("li");
          item.classList.add('list-group-item');
          item.classList.add('bg-dark');            
          item.onclick = function(){setActiveDevice(device.id, false, "playlists")};
          item.appendChild(document.createTextNode(device.name));
          ulLists.appendChild(item);
        }
      }
    }
  }
  catch(err){
    console.error(err);
    if(err.response && isTokenExpiredError(err.response)){
      await getNewToken(); 
      await getDevices(showDeviceList);
    }
  } 
}

async function getCurrPlayback(){
  //All the controls' status are updated based on the current playback data
  try{
    let res = await axios.get(`${apiUrl}/me/player`, {
      headers: {"Authorization": "Bearer " + userSettings.token}});
    if(res && res.data){
      spotifyData.currPlayback= res.data;
      //Update the album art image
      if(res.data.item && res.data.item.album && res.data.item.album.images && res.data.item.album.images.length > 0){
        imgAlbumArt.src = res.data.item.album.images[0].url;
        imgAlbumArt.style.display = "block";        
        tempAlbumArt.style.display = "none";
      }
      else{
        imgAlbumArt.style.display = "none";        
        tempAlbumArt.style.display = "block";
      }    
      //Update the player status (play/pause)
      if(res.data.is_playing === true){
        spotifyData.status = "play";          
        ctrlPlay.style.display = "none";
        ctrlPause.style.display = "block";
        //Schedule the polling task
        if(!spotifyRefreshTimer) 
          spotifyRefreshTimer = schedulePlaybackRefresh();
      }
      else{
        spotifyData.status = "pause";          
        ctrlPlay.style.display = "block";
        ctrlPause.style.display = "none";
        console.log("clear refresh schedule");
        //Stop the playback polling schedule since it is not playing now
        if(spotifyRefreshTimer) {
          clearTimeout(spotifyRefreshTimer);
          spotifyRefreshTimer = null;
        }
      }        
      //Update shuffle state
      if (res.data.shuffle_state)
        ctrlShuffle.classList.add("active");        
      else
        ctrlShuffle.classList.remove("active");        
        
      //Update the plaback title    
      if (res.data.item && res.data.item.name)
        divTitle.innerHTML= res.data.item.name;
      else
        divTitle.innerHTML= "";
      
      //Update the playback artist
      let artistsText = "";
      if (res.data.item && res.data.item.artists){
        for (let artist  of res.data.item.artists){
          if (!artistsText) artistsText = artist.name;
          else artistsText += `, ${artist.name}`;
        }
      }
      divArtist.innerHTML = artistsText;
      
      //Update the current selected playlist
      if(spotifyData.currPlayback && spotifyData.currPlayback.context && spotifyData.currPlayback.context.uri){
        //Remove the current active class
        for (let item of ulLists.childNodes){
          item.classList.remove("active");            
        }
        //Add active class to the currently played playlist
        let activeList = document.getElementById(spotifyData.currPlayback.context.uri);
        if(activeList) activeList.classList.add("active");
      }
    }
  }
  catch(err){
    console.error(err);
    if(err.response && isTokenExpiredError(err.response)){
      await getNewToken(); 
      await getCurrPlayback();
    }
  }  
}

async function controlPlayer(action, params = {}){
  let url = `${apiUrl}/me/player/${action}`;
  let data = {};
  let method = "put";
  if(["next", "previous"].includes(action))
    method = "post";    
  //Specify which device to send the play command  
  if (activeDeviceId) url += `?device_id=${activeDeviceId}`  
  //To play a specific album, song, or playlist
  if (params.contextUri){
    data.context_uri = params.contextUri;
  }
  try{  
    let res = await axios({method, url, data,    
      headers: {"Authorization": "Bearer " + userSettings.token}});
    //resync the player playback data after a tiny delay
    setTimeout(getCurrPlayback, 50);
  }
  catch(err){
    console.error(err);
    if (err.response){
      if(isNoActiveDeviceError(err.response)){
        console.warn("No active device. Please select a device first.");
      }
      else if(isTokenExpiredError(err.response)){
        await getNewToken(); 
        await controlPlayer(action, params);
      }
    }    
  }
}

async function shuffle(){
  let isShuffle = spotifyData && spotifyData.currPlayback && spotifyData.currPlayback.shuffle_state;
  isShuffle = !isShuffle ? true : false; //toggle shuffle state
  try{
    let res =  axios.put(`${apiUrl}/me/player/shuffle?state=${isShuffle}`, {}, {
      headers: {"Authorization": "Bearer " + userSettings.token}});
    //resync the player playback data after a tiny delay
    setTimeout(getCurrPlayback, 50);
  }
  catch(err){
    console.error(err);
    if(err.response && isTokenExpiredError(err.response)){
      await getNewToken(); 
      await shuffle();
    }
  }
}

/*Common known errors*/
function isTokenExpiredError(errorResponse){
  if(errorResponse && errorResponse.data && errorResponse.data.error && errorResponse.data.error.message){
    if(errorResponse.data.error.message.indexOf("token expired") >= 0){
      console.warn("Token is expired");
      return true;
    }      
  }
  return false;
}

function isNoActiveDeviceError(errorResponse){
  if(errorResponse && errorResponse.data && errorResponse.data.error){
    return errorResponse.data.error.reason === "NO_ACTIVE_DEVICE";
  }
  return false;
}
/*Current playback polling scheduler*/
function schedulePlaybackRefresh(){
  getCurrPlayback();
  console.log("refresh playback in 3 seconds");
  return setTimeout(schedulePlaybackRefresh, 3000);
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
